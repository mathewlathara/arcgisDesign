{% extends 'adminlte/base.html' %}
{% load static %}
{% block extra_head %}
<link rel="stylesheet" href="https://js.arcgis.com/4.23/esri/themes/light/main.css">
<style>
    html,
    body,
    #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
    }

    .sidenav {
        height: 100%;
        width: 0;
        position: fixed;
        z-index: 1;
        top: 0;
        right: 0;
        background-color: #111;
        overflow-x: hidden;
        transition: 0.5s;
        padding-top: 60px;
    }

    .sidenav a {
        padding: 8px 8px 8px 32px;
        text-decoration: none;
        font-size: 25px;
        color: #818181;
        display: block;
        transition: 0.3s;
    }

    .sidenav a:hover {
        color: #f1f1f1;
    }

    .sidenav .closebtn {
        position: absolute;
        top: 0;
        right: 25px;
        font-size: 36px;
        margin-left: 50px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-2">
            <ul class="list-group">
                <li class="list-group-item">
                    <label>Select a year</label>
                    <span>
                        <select class="custom-select yearFrom">
                            
                        </select>
                    </span>
                </li>
                <div>&nbsp;</div>
                <div>&nbsp;</div>
                <div>&nbsp;</div>
                <div>&nbsp;</div>
                <div>&nbsp;</div>
                <div>&nbsp;</div>
                <div>&nbsp;</div>
                <div>&nbsp;</div>
                <div>&nbsp;</div>
                <div>&nbsp;</div>
                <div>&nbsp;</div>
                <div>&nbsp;</div>
                <div>&nbsp;</div>
                <div>&nbsp;</div>
                <div>&nbsp;</div>
                <div>&nbsp;</div>
                <div>&nbsp;</div>
                <div>&nbsp;</div>
                <div>&nbsp;</div>
                <div>&nbsp;</div>
                <div>&nbsp;</div>
                <div>&nbsp;</div>
                <div>&nbsp;</div>
                <div>&nbsp;</div>

        </div>
        <div class="col-md-10">
            <div id="viewDiv"></div>
        </div>
    </div>
</div>

<input type="hidden" id="stationid">
<input type="hidden" id="yearselectedinputhidden" value="{{yearselected}}">

<div id="mySidenav" class="sidenav">
    <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
</div>

<div class="modal fade" id="demographicsGraphModal">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Station ID: <span id="stationdisplaymodalbox"></span></h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div id="tester" class="col-lg-12"></div>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>

{% endblock %}

{% block javascript %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="{% static 'admin-lte/plugins/bootstrap/js/bootstrap.bundle.min.js' %} "></script>
<script src="https://cdn.plot.ly/plotly-2.11.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js "></script>
<script src="https://js.arcgis.com/4.23/"></script>
<script>
    var jsonpointfile = {{ jsonvalue|safe }}
    $(document).ready(function () {
        loadmapvalues(1);

        var yearlist = ["2017", "2013", "2008", "2007", "2002"];
        yearselectbox = "<option value='' disabled selected>Select a year</option>";
        for(let j = 0; j < yearlist.length; j++){
            if(yearlist[j] == "{{yearselected}}"){
                yearselectbox += "<option value="+yearlist[j]+" selected>"+yearlist[j]+"</option>";
            }else{
                yearselectbox += "<option value="+yearlist[j]+">"+yearlist[j]+"</option>";
            }
        }

        $(".yearFrom").html(yearselectbox);

        $(document).on('change', '.yearFrom', function(){
            var yearselected = $(this).val();
            window.location.href='map_ex?yearid=' + yearselected;
        });
    });
    function loadmapvalues(filtertype) {
        require(["esri/config", "esri/Map", "esri/views/MapView", "esri/layers/FeatureLayer", "esri/widgets/LayerList", "esri/Graphic", "esri/layers/GraphicsLayer", "esri/widgets/Legend"], function (esriConfig, Map, MapView, FeatureLayer, LayerList, Graphic, GraphicsLayer, Legend) {

            esriConfig.apiKey = "AAPKfb2205b571aa464b8280e4e744e3bde7rK2eQbS-fVv05DUtFVJUqBVoJjMIQGIMHK7rqQR-In8y-qSZSmNtobECX3jGCzGG";

            const template = {
                // autocasts as new PopupTemplate()
                title: "Demographics",
                content: [
                    {
                        // It is also possible to set the fieldInfos outside of the content
                        // directly in the popupTemplate. If no fieldInfos is specifically set
                        // in the content, it defaults to whatever may be set within the popupTemplate.
                        type: "fields",
                        fieldInfos: [
                            {
                                fieldName: "Landuse_Fu",
                                label: "Land type"
                            },
                            {
                                fieldName: "layer",
                                label: "Layer",
                                format: {
                                    digitSeparator: true,
                                    places: 0
                                }
                            },
                            {
                                fieldName: "VegType",
                                label: "Vegitation type",
                                format: {
                                    digitSeparator: true,
                                    places: 0
                                }
                            },
                            {
                                fieldName: "Topographi",
                                label: "Topography",
                                format: {
                                    digitSeparator: true,
                                    places: 0
                                }
                            }
                        ]
                    }
                ]
            };

            const TRCALanduseRenderer = {
                type: "simple", // autocasts as new SimpleRenderer()
                symbol: {
                    type: "simple-fill", // autocasts as new SimpleFillSymbol()
                    color: "rgb(213, 210, 210)",
                    outline: {
                        color: "rgb(0, 0, 0)",
                        width: 0.01
                    }
                }
            };

            const featureLayer = new FeatureLayer({
                url: "https://services.arcgis.com/t0XyVE44waBIPBFr/arcgis/rest/services/merged_land_cover/FeatureServer/0",
                // popupTemplate: template,
                renderer: TRCALanduseRenderer,
                title: "TRCA Landuse base map"
            });

            /*-------------------------------- TRCA base land ----------------------------------------------------------------*/

            function TRCACustomRegion(feature) {
                var stationid = feature.graphic.attributes.UniqueID;
                const div = document.createElement("div");
                console.log("I am here ------>" + JSON.stringify(stationid));
                $.ajax({
                    type: 'GET',
                    url: 'http://localhost:8000/arcgisMapParametersDurhamRegion/?stationid=' + stationid,
                    success: function(data) {
                        console.log(JSON.stringify(data));
                        div.innerHTML = "<p><u><b>Station ID: "+ data.stationid +"</b></u></p><ul><li>Avg chloride: "+data.avgchloride+"</li><li>Avg population: "+data.avgpopulation+"</li><li>Avg phosphorus: "+data.avgphosphorus+"</li><li>Avg nitrogen: "+data.avgnitrogen+"</li></ul>";
                    },
                    error: function(error) {
                        alert("error");
                    }
                });
                return div;
            }

            const TRCABASEtemplate = {
                // autocasts as new PopupTemplate()
                title: "TRCA region",
                outFields: ["UniqueID"],
                content: TRCACustomRegion
                // content: [
                //     {
                //         // It is also possible to set the fieldInfos outside of the content
                //         // directly in the popupTemplate. If no fieldInfos is specifically set
                //         // in the content, it defaults to whatever may be set within the popupTemplate.
                //         type: "fields",
                //         fieldInfos: [
                //             {
                //                 fieldName: "layer",
                //                 label: "Layer",
                //                 format: {
                //                     digitSeparator: true,
                //                     places: 0
                //                 }
                //             },
                //         ]
                //     }
                // ]
            };

            const TRCARenderer = {
                type: "simple", // autocasts as new SimpleRenderer()
                symbol: {
                    type: "simple-fill", // autocasts as new SimpleFillSymbol()
                    color: "rgb(79, 102, 68)",
                    outline: {
                        color: "rgb(255, 255, 255)",
                        width: 0.5
                    }
                }
            };

            const TRCABaseLayer = new FeatureLayer({
                url: "https://services6.arcgis.com/1c4OxPOWDbePZZBO/arcgis/rest/services/newtrcaregion/FeatureServer/0",
                popupTemplate: TRCABASEtemplate,
                renderer: TRCARenderer,
                opacity: 0.5,
                title: "TRCA region"
            });

            /* ---------------------------------- Durham region -------------------------------------------------*/

            const durhamAdditionalDetials = {
                title: "Show details",
                id: "detail-this",
                image: "static/admin-lte/dist/img/adddetailsimg.png" // this section is for adding additional details button
            };

            function durhamregCustomRegion(feature) {
                var stationid = feature.graphic.attributes.UniqueID;
                const div = document.createElement("div");
                console.log("I am here ------>" + JSON.stringify(stationid));
                $.ajax({
                    type: 'GET',
                    url: 'http://localhost:8000/arcgisMapParametersDurhamRegion/?stationid=' + stationid,
                    success: function(data) {
                        console.log(JSON.stringify(data));
                        $("#stationid").val(stationid);
                        div.innerHTML = "<p><u><b>Station ID: "+ data.stationid +"</b></u></p><ul><li>Avg chloride: "+data.avgchloride+"</li><li>Avg population: "+data.avgpopulation+"</li><li>Avg phosphorus: "+data.avgphosphorus+"</li><li>Avg nitrogen: "+data.avgnitrogen+"</li></ul>";
                    },
                    error: function(error) {
                        alert("error");
                    }
                });
                return div;
            }

            const durhamtemplate = {
                // autocasts as new PopupTemplate()
                title: "Durham region",
                outFields: ["UniqueID"],
                content: durhamregCustomRegion,
                actions: [durhamAdditionalDetials]
                // content: [
                //     {
                //         // It is also possible to set the fieldInfos outside of the content
                //         // directly in the popupTemplate. If no fieldInfos is specifically set
                //         // in the content, it defaults to whatever may be set within the popupTemplate.
                //         type: "fields",
                //         fieldInfos: [
                //             {
                //                 fieldName: "layer",
                //                 label: "Layer",
                //                 format: {
                //                     digitSeparator: true,
                //                     places: 0
                //                 }
                //             },
                //         ]
                //     }
                // ]
            };

            const DurhamRenderer = {
                type: "simple", // autocasts as new SimpleRenderer()
                symbol: {
                    type: "simple-fill", // autocasts as new SimpleFillSymbol()
                    color: "rgb(209, 213, 187)",
                    outline: {
                        color: "rgb(255, 255, 255)",
                        width: 0.5
                    }
                }
            };

            const DurhamLayer = new FeatureLayer({
                url: "https://services6.arcgis.com/1c4OxPOWDbePZZBO/arcgis/rest/services/durham_edited/FeatureServer/0",
                popupTemplate: durhamtemplate,
                renderer: DurhamRenderer,
                opacity: 0.4,
                title: "Durham region",
            });

            function createFillSymbol(value, color) {
                return {
                    "value": value,
                    "symbol": {
                        "color": color,
                        "type": "simple-fill",
                        "style": "solid",
                        "outline": {
                            color: "rgb(0, 0, 0)",
                            width: 0.1
                        }
                    },
                    "label": value
                };
            }

            const SpacesRenderer2017 = {
                type: "unique-value",
                field: "Landuse_Fu",
                uniqueValueInfos: [
                    createFillSymbol("Agricultural", "#3282bd"),
                    createFillSymbol("Institutional", "#EBF90D"),
                    createFillSymbol("Roads", "#FB1102"),
                    createFillSymbol("Lacustrine", "#05FBDC"),
                    createFillSymbol("Airport", "#09F4F5"),
                    createFillSymbol("Medium Density Residential", "#E5550E"),
                    createFillSymbol("Forest", "#08B22B"),
                    createFillSymbol("Commercial", "#766bb3"),
                    createFillSymbol("Industrial", "#766bb3"),
                    createFillSymbol("Meadow", "#48FB12"),
                    createFillSymbol("Estate Residential", "#0752F6"),
                    createFillSymbol("Mixed Commercial Entertainment", "#CB07F6")
                ],
                outline: {
                    color: "rgb(0, 0, 2)",
                    width: 0.1
                }
            };

            const SpaceRenderOtherThan2017 = {
                type: "unique-value",
                field: "HABITAT",
                uniqueValueInfos: [
                    createFillSymbol("forest", "#08B22B"),
                    createFillSymbol("wetland", "#EBF90D"),
                    createFillSymbol("meadow", "#48FB12"),
                    createFillSymbol("succ", "#766bb3")
                ],
                outline: {
                    color: "rgb(0, 0, 2)",
                    width: 0.1
                }
            };

            // Create the layer and set the renderer
            var yearselectedinputhidden = $("#yearselectedinputhidden").val();
            var openspacerendererselected = null
            if(yearselectedinputhidden == "2017"){
                openspacerendererselected = SpacesRenderer2017;
            }else{
                openspacerendererselected = SpaceRenderOtherThan2017;
            }
            const induvidualLayers = new FeatureLayer({
                url: "{{regiondemographicrenderurl|safe}}",
                renderer: openspacerendererselected,
                // popupTemplate: template,
                // opacity: 0.9,
                title: "TRCA Landuse {{yearselected}} demographics"
            });

            const ELCTRCARenderer = {
                type: "simple", // autocasts as new SimpleRenderer()
                symbol: {
                    type: "simple-fill", // autocasts as new SimpleFillSymbol()
                    color: "rgb(189, 184, 135)",
                    outline: {
                        color: "rgb(0, 0, 0)",
                        width: 0.1
                    }
                }
            };

            const ELCTRCA = new FeatureLayer({
                url: "https://services.arcgis.com/t0XyVE44waBIPBFr/arcgis/rest/services/elc_trca_shp/FeatureServer/0",
                // popupTemplate: template,
                renderer: ELCTRCARenderer,
                title: "ELC TRCA"
            });

            const CLOCALandcoverRender = {
                type: "simple", // autocasts as new SimpleRenderer()
                symbol: {
                    type: "simple-fill", // autocasts as new SimpleFillSymbol()
                    color: "rgb(189, 135, 158)",
                    outline: {
                        color: "rgb(0, 0, 0)",
                        width: 0.1
                    }
                }
            };

            const CLOCALandcoverBase = new FeatureLayer({
                url: "https://services.arcgis.com/t0XyVE44waBIPBFr/arcgis/rest/services/cloca_land_covershp/FeatureServer/0",
                // popupTemplate: template,
                renderer: CLOCALandcoverRender,
                title: "CLOCA Land cover"
            });

            const ECOLOGLANDClassificRender = {
                type: "simple", // autocasts as new SimpleRenderer()
                symbol: {
                    type: "simple-fill", // autocasts as new SimpleFillSymbol()
                    color: "rgb(218, 210, 220)",
                    outline: {
                        color: "rgb(0, 0, 0)",
                        width: 0.1
                    }
                }
            };

            const ECOLOGLANDClassificBase = new FeatureLayer({
                url: "https://services.arcgis.com/t0XyVE44waBIPBFr/arcgis/rest/services/cloca_land_covershp/FeatureServer/0",
                // popupTemplate: template,
                renderer: ECOLOGLANDClassificRender,
                title: "Ecological land classification"
            });

            const map = new Map({
                basemap: "gray-vector",
                layers: [featureLayer, induvidualLayers, ELCTRCA, CLOCALandcoverBase, ECOLOGLANDClassificBase, DurhamLayer]
            });

            const graphicsLayer = new GraphicsLayer({
                title: "Station points"
            });
            map.add(graphicsLayer);

            const simpleMarkerSymbol = {
                // type: "simple-marker",
                // color: [226, 119, 40],  // Orange
                // outline: {
                //     color: [255, 255, 255], // White
                //     width: 1
                // }
                type: "picture-marker",
                url: "static/admin-lte/dist/img/star.png",
                width: "25px",
                height: "25px"
            };

            for(var i = 0; i < jsonpointfile.length; i++){
                // console.log(jsonpointfile[i])
                const point = { //Create a point
                    type: "point",
                    longitude: jsonpointfile[i].longitude,
                    latitude: jsonpointfile[i].latitude
                };

                const popupTemplate = {
                    title: "{Name}",
                    content: "{Description}",
                }

                const attributes = {
                    Name: "Station name: " + jsonpointfile[i].station,
                }

                const pointGraphic = new Graphic({
                    geometry: point,
                    symbol: simpleMarkerSymbol,
                    attributes: attributes,
                    popupTemplate: popupTemplate
                });
                graphicsLayer.add(pointGraphic);
            }

            const view = new MapView({
                container: "viewDiv",
                map: map,
                center: [-78.8911306275, 43.9299554612],
                zoom: 9
            });

            function piechart(xvalues, yvalues, colorneeded, displaytext){
                var xValues = xvalues;
                var yValues = yvalues;
                var barColors = colorneeded;

                new Chart("myChart", {
                type: "pie",
                data: {
                    labels: xValues,
                    datasets: [{
                    backgroundColor: barColors,
                    data: yValues
                    }]
                },
                options: {
                    title: {
                    display: true,
                    text: displaytext
                    }
                }
                });
            }

            view.popup.on("trigger-action", (event) => {
            // Execute the measureThis() function if the measure-this action is clicked
                if (event.action.id === "detail-this") {
                    let stationid = $("#stationid").val();
                    $.ajax({
                    type: 'GET',
                    url: 'http://localhost:8000/arcgisMapSoilDetailsAPI/?stationid=' + stationid,
                        success: function(data) {
                            if(data.status === "success"){
                                $("#stationdisplaymodalbox").html(stationid);
                                $('#demographicsGraphModal').modal('show');
                                // piechart(["CSS/with clay", "CSS/All together", "CSS/with sand", "CSS/with silt", "CSS/unknown"], [data.totalTCLAYwtd, data.totalTOTHERwtd, data.totalTSANDwtd, data.totalTSILTwtd, data.totalTUNKNOWNwtd], [ "#F2900B", "#F2D20B", "#DDFE04", "#A9F20A", "#D7DCCC"], "Soil/Sand data")
                                // var trace1 = {
                                //     x: [0, 1, 2, 3, 4, 5],
                                //     y: [1.5, 1, 1.3, 0.7, 0.8, 0.9],
                                //     type: 'scatter'
                                // };

                                // var trace2 = {
                                //     x: [0, 1, 2, 3, 4, 5],
                                //     y: [1, 0.5, 0.7, -1.2, 0.3, 0.4],
                                //     type: 'bar'
                                // };
                                var listarrayvalue = [];
                                for(var i = 0; i < data.linegraphreturnlist.length; i++){
                                    console.log(data.linegraphreturnlist[i]);
                                    listarrayvalue.push(data.linegraphreturnlist[i])
                                }

                                // var data = [trace1, trace2];
                                var layout = {xaxis: {autorange: 'reversed', title: 'Days preceeding collection'}, yaxis: {title: 'Precipitated mean temperature(\xB0C)'}};
                                Plotly.newPlot('tester', listarrayvalue, layout);
                            }else{
                                alert("Proper data not present");
                            }
                        },
                        error: function(error) {
                            alert("error");
                        }
                    });
                    // alert(stationid);
                }
            });

            const legend = new Legend({
                view: view,
                style: "card"
            });
            view.ui.add(legend, "bottom-left");

            view.when(() => {
                const layerList = new LayerList({
                    view: view
                });

                // Add widget to the top right corner of the view
                view.ui.add(layerList, "top-right");
            });
            

            // function openNav() {
            //     document.getElementById("mySidenav").style.width = "400px";
            // }

            // view.popup.on("trigger-action", (event) => {
            //     // Execute the measureThis() function if the measure-this action is clicked
            //     if (event.action.id === "detail-this") {
            //         openNav();
            //     }
            // });

        });
    }
    function closeNav() {
        document.getElementById("mySidenav").style.width = "0";
    }
</script>
{% endblock %}